<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" 
      xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8">
    <title>BookKit Tests</title>

    <link rel="stylesheet" href="../bower_components/qunit/qunit/qunit.css">

    <!-- BOOKKIT INJECTION -->
    <script type="text/javascript" src="../bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="../bower_components/underscore/underscore.js"></script>
    <script type="text/javascript" src="../bookkit/js/jquery.measure.js"></script>
    <script type="text/javascript" src="../bookkit/js/bookkit.cfi.js"></script>
    <script type="text/javascript" src="../bookkit/js/bookkit.annotation.js"></script>
    <!-- /BOOKKIT INJECTION -->

    <style type="text/css">
        .test-content { 
            display: none;
        }
    </style>
  </head>
  <body>
    <!-- Test content that matches my own Ulysses.epub in DOM structure
         up until it breaks off. This should mean the test CFIs are valid 
         for the real book as well. -->
    <section class="test-content">
      <p>Stately, plump Buck Mulligan came from the stairhead, bearing a bowl of lather on which a mirror and a razor lay crossed. A yellow dressinggown, ungirdled, was sustained gently behind him on the mild morning air. He held the bowl aloft and intoned:</p>
      <p>— <em>Introibo ad altare Dei</em>.</p>
      <p>Halted, he peered down the dark winding stairs and called out coarsely:</p>
      <p>— Come up, Kinch! Come up, you fearful jesuit!</p>
      <p>Solemnly he came forward and mounted the round gunrest. He faced about and blessed gravely thrice the tower, the surrounding land and the awaking mountains. Then, catching sight of Stephen Dedalus, he bent towards him and made rapid crosses in the air, gurgling in his throat and shaking his head. Stephen Dedalus, displeased and sleepy, leaned his arms on the top of the staircase and looked coldly at the shaking gurgling face that blessed him, equine in its length, and at the light untonsured hair, grained and hued like pale oak.</p>
      <p>Buck Mulligan peeped an instant under the mirror and then covered the bowl smartly.</p>
      <p>— Back to barracks! he said sternly.</p>
      <p>He added in a preacher's tone:</p>
      <p>— For this, O dearly beloved, is the genuine Christine: body and soul and blood and ouns. Slow music, please. Shut your eyes, gents. One moment. A little trouble about those white corpuscles. Silence, all.</p>
      <p>He peered sideways up and gave a long slow whistle of call, then paused awhile in rapt attention, his even white teeth glistening here and there with gold points. Chrysostomos. Two strong shrill whistles answered through the calm.</p>
      <p>— Thanks, old chap, he cried briskly. That will do nicely. Switch off the current, will you?</p>
      <p>He skipped off the gunrest and looked gravely at his watcher, gathering about his legs the loose folds of his gown. The plump shadowed face and sullen oval jowl recalled a prelate, patron of arts in the middle ages. A pleasant smile broke quietly over his lips.</p>
      <p>— The mockery of it! he said gaily. Your absurd name, an ancient Greek!</p>
      <p>He pointed his finger in friendly jest and went over to the parapet, laughing to himself. Stephen Dedalus stepped up, followed him wearily halfway and sat down on the edge of the gunrest, watching him still as he propped his mirror on the parapet, dipped the brush in the bowl and lathered cheeks and neck.</p>
      <p>Buck Mulligan's gay voice went on.</p>
      <p>— My name is absurd too: Malachi Mulligan, two dactyls. But it has a Hellenic ring, hasn't it? Tripping and sunny like the buck himself. We must go to Athens. Will you come if I can get the aunt to fork out twenty quid?</p>
      <p>He laid the brush aside and, laughing with delight, cried:</p>
      <p>— Will he come? The jejune jesuit!</p>
      <p>Ceasing, he began to shave with care.</p>
      <p>— Tell me, Mulligan, Stephen said quietly.</p>
      <p>— Yes, my love?</p>
      <p>— How long is Haines going to stay in this tower?</p>
      <p>Buck Mulligan showed a shaven cheek over his right shoulder.</p>
      <p>— God, isn't he dreadful? he said frankly. A ponderous Saxon. He thinks you're not a gentleman. God, these bloody English! Bursting with money and indigestion. Because he comes from Oxford. You know, Dedalus, you have the real Oxford manner. He can't make you out. O, my name for you is the best: Kinch, the knife-blade.</p>
      <p>He shaved warily over his chin.</p>
    </section>

    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script src="../bower_components/qunit/qunit/qunit.js"></script>
    <script>

    QUnit.module("CFI");

    // Set up the document portion of CFIs 
    BookKit.CFI.documentStep = "/6/12!";

    QUnit.test("BookKit.CFI: parse existing single-node cfi", function(assert) {
        // Test single node CFI
        var cfistring = "epubcfi(/6/12!/4/2/4/2,/1:0,/1:22)";
        var cfi = new BookKit.CFI(cfistring).parseAndResolve();
        // Try to do a bit of introspection
        assert.equal(cfi.steps.length, 3, "parsed");
        assert.equal(cfi.ranges.length, 1, "resolved");
    });

    QUnit.test("BookKit.CFI: parse existing multiple node-spanning cfi", function(assert) {
        var cfistring = "epubcfi(/6/12!/4/2,/6/1:8,/8/1:9)";
        var cfi = new BookKit.CFI(cfistring).parseAndResolve();
        // Try to do a bit of introspection
        assert.equal(cfi.steps.length, 3, "parsed");
        assert.equal(cfi.ranges.length, 4, "resolved");
    });
    
    QUnit.test("BookKit.CFI: create single-node cfi for range", function(assert) {
        // "Introibo ad altare Dei"
        var singleNode = $($($('.test-content').contents()[3]).contents()[1]).contents()[0];
        var range = document.createRange();
        range.setStart(singleNode, 0);
        range.setEnd(singleNode, 22);
        var cfi = BookKit.CFI.cfiForRange(range);
        assert.equal(cfi.cfistring, "epubcfi(/6/12!/4/2/4/2,/1:0,/1:22)", "valid cfi");
    });

    QUnit.test("BookKit.CFI: create multiple node-spanning cfi for range", function(assert) {
        // "fearful jesuit! Solemnly"
        var startNode = $($('.test-content').contents()[7]).contents()[0];
        var endNode = $($('.test-content').contents()[9]).contents()[0];
        var range = document.createRange();
        range.setStart(startNode, 31);
        range.setEnd(endNode, 8);
        var cfi = BookKit.CFI.cfiForRange(range);
        assert.equal(cfi.cfistring, "epubcfi(/6/12!/4/2,/8/1:31,/10/1:8)", "valid cfi");
    });
    
    QUnit.module("Annotations");

    QUnit.test("BookKit.Annotation: create annotation from cfi string", function(assert) {
        var annotation = new BookKit.Annotation({cfi: "epubcfi(/6/12!/4/2,/6/1:8,/8/1:9)"});
        assert.equal(annotation.cfi.cfistring, "epubcfi(/6/12!/4/2,/6/1:8,/8/1:9)", 
            "valid annotation");
    });
    
    QUnit.test("BookKit.Annotation: create annotation from cfi object", function(assert) {
        var cfistring = "epubcfi(/6/12!/4/2,/8/1:31,/10/1:8)";
        var cfi = new BookKit.CFI(cfistring).parseAndResolve();
        var annotation = new BookKit.Annotation({cfi: cfi});
        assert.equal(annotation.cfi.cfistring, "epubcfi(/6/12!/4/2,/8/1:31,/10/1:8)", 
            "valid annotation");
    });

    QUnit.test("BookKit.Annotation: add annotation from cfi string", function(assert) {
        var cfistring = "epubcfi(/6/12!/4/2,/6/1:8,/8/1:9)";
        var annotation = BookKit.Annotation.addAnnotation(cfistring, {});
        assert.equal(annotation.cfi.cfistring, "epubcfi(/6/12!/4/2,/6/1:8,/8/1:9)",
            "valid annotation");
        assert.ok($.inArray(annotation, BookKit.Annotations), "added");
    });

    QUnit.test("BookKit.Annotation: add annotation from cfi object", function(assert) {
        var cfistring = "epubcfi(/6/12!/4/2,/8/1:31,/10/1:8)";
        var cfi = new BookKit.CFI(cfistring).parseAndResolve();
        var annotation = BookKit.Annotation.addAnnotation(cfi, {});
        assert.equal(annotation.cfi.cfistring, "epubcfi(/6/12!/4/2,/8/1:31,/10/1:8)",
            "valid annotation");
        assert.ok($.inArray(annotation, BookKit.Annotations), "added");
    });

  </script>
</body>
</html>

