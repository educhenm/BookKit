/*! bookkit 12-10-2014 */
var BookKit=BookKit||{};BookKit.Annotations=BookKit.Annotations||{},BookKit.Annotation=function(){var a=function(a){var b=this,c={cfi:null,bookmark:!1,bookmarkStyle:"none",bookmarkColor:"none",highlight:!1,highlightStyle:"none",highlightColor:"none",note:!1,noteStyle:"none",noteColor:"none",noteText:""};b.options=$.extend(!0,{},c,a),b.cfi=void 0,b.init=function(){b.cfi="string"==typeof b.options.cfi||b.options.cfi instanceof String?new BookKit.CFI(b.options.cfi).parseAndResolve():b.options.cfi},b.init()};return function(b){return new a(b)}}(),BookKit.Annotation.addAnnotation=function(a,b){var c;c="string"==typeof a||a instanceof String?a:a.cfistring,b.cfi=a;var d=new BookKit.Annotation(b);return BookKit.Annotations[c]=d,$(document).trigger("addedAnnotation",[d]),d},BookKit.Annotation.removeAnnotation=function(a){var b=void 0;b="string"==typeof a||a instanceof String||a instanceof BookKit.CFI?"string"==typeof a||a instanceof String?new BookKit.CFI(a).parseAndResolve():a:c.cfi;var c=BookKit.Annotations[b.cfistring],d=BookKit.Annotations.indexOf(b.cfistring);BookKit.Annotations.splice(d,1),$(document).trigger("removedAnnotation",[c])};var BookKit=BookKit||{};BookKit.Behavior=BookKit.Behavior||{},function(){BookKit.Behavior.Navigate=function(a){var b=this,c={horizontal:!0,columnsToScroll:2,columnToStart:0};b.options=$.extend({},c,a),b.presentation=void 0,b.nextColumn=function(){var a=b.presentation.currentContentPosition(),c=b.presentation.contentDivisions(),d=a+b.options.columnsToScroll;c>d&&b.scrollTo(d,!0)},b.previousColumn=function(){var a=b.presentation.currentContentPosition(),c=a-b.options.columnsToScroll;c>=0&&b.scrollTo(c,!0)},b.scrollTo=function(a,c){var d=a*b.presentation.actualContentWidth();b.options.horizontal?c?b.$el.animate({scrollLeft:d},b.presentation.options.animationDuration):b.$el.scrollLeft(d):b.$el.scrollTop(d)},b.init=function(){$(document).on("presented",function(a,c){b.presentation=c,b.$el=$(b.presentation.options.presentationElement),b.scrollTo(b.options.columnToStart),setTimeout(function(){},500)}),$(document).keydown(function(a){37==a.keyCode?(console.log("prev"),b.previousColumn()):39==a.keyCode&&b.nextColumn()})},b.init()},BookKit.Behavior.HighlightImmediately=function(a){var b=this,c={style:"highlight",color:"blue"};b.options=$.extend({},c,a),b.init=function(){$(document).on("presented",function(a,c){b.presentation=c,b.$el=$(b.presentation.options.presentationElement),b.$el.on("mouseup",function(){var a=BookKit.CFI.selectionCFI();a&&void 0!=a.ranges&&(console.log(a.cfistring),window.getSelection().removeAllRanges(),BookKit.Annotation.addAnnotation(a,{highlight:a,highlightStyle:b.options.style,highlightColor:b.options.color}))})})},b.init()},BookKit.Behavior.NoteSplitter=function(a){var b=this,c={};b.options=$.extend({},c,a),b.presentation=void 0,b.openNote=function(a){var b=$("#-BookKit-Behavior-NoteSplitter-Note-"+a.cfi.safeAttr());if(!(b.length>0)){var c,d=a.cfi.ranges[a.cfi.ranges.length-1],e=d.endContainer;e.nodeType==Node.TEXT_NODE?c=e.parentNode:(c=e,console.log(c,"is not",e));var f=$(e.splitText(d.endOffset)).detach(),g=$(c).clone().empty().append(f);$(g).insertAfter($(c));var h=document.createElement("div");$(h).attr("class","-BookKit-Behavior-NoteSplitter-Note"),$(h).attr("id","-BookKit-Behavior-NoteSplitter-Note-"+a.cfi.safeAttr()),$(h).html(a.options.noteText),$(h).insertAfter($(c)),$(document).trigger("presentationChanged")}},b.closeNote=function(a){var b;b=$(void 0!=a?".-BookKit-Behavior-NoteSplitter-Note-"+a.cfi.safeAttr():".-BookKit-Behavior-NoteSplitter-Note"),$(b).each(function(){var a=this;console.log(a);var b=$(a).prev();console.log("enclosingNode",b);var c=$(a).next();console.log("enclosingNodeCopy",c);var d=$(c[0].firstChild).detach();$(b).append(d),$(c).remove(),b[0].normalize(),$(a).remove()}),$(document).trigger("presentationChanged")},b.init=function(){$(document).on("presented",function(a,c){b.presentation=c,b.$el=$(b.presentation.options.presentationElement),b.$el.on("click",function(a){var c;if($.each(BookKit.Annotations,function(b,d){d.cfi.containsPoint(a.clientX,a.clientY)&&d.options.note&&(c=d)}),void 0!=c)b.openNote(c);else{var d=$(".-BookKit-Behavior-NoteSplitter-Note");d.length>0&&(console.log("closing notes"),b.closeNote())}})})},b.init()}}();var BookKit=BookKit||{},_parsed_cfis=BookKit._parsed_cfis={};!function(){BookKit.CFI=function(a,b,c,d){var e=this;e.cfistring=a,e.steps=b||null,e.range=c||null,e.ranges=d||null;var f=function(a){for(var b=0,c=0,d=[];b<a.length;){var e=a.indexOf("[",b),f=a.indexOf("]",b),g=a.indexOf(",",b);if(-1==g)break;if(g>e&&f>g||g>f&&f>0){if(!(f+1<a.length))break;b=f+1}else d.push(a.substring(c,g)),c=g+1,b=c}return c<a.length&&d.push(a.substring(c,a.length)),d},g=function(a){var b=[];return _.each(a,function(a){if(0!=a.length){var c={index:-1,assertion:null,offset:-1,redirection:!1},d=a.indexOf("!");d>0&&(c.redirection=!0);var e=a.indexOf("[");if(e>0){var f=a.indexOf("]");c.assertion=a.substring(e+1,f)}var g=a.indexOf(":");g>0&&(c.offset=parseInt(a.substring(g+1))),c.index=parseInt(a),b.push(c)}}),b},h=function(){var a=e.cfistring;if(null!=BookKit._parsed_cfis[a])return BookKit._parsed_cfis[a].steps;if(0==a.indexOf("epubcfi(")){a=a.substring("epubcfi(".length,a.length-")".length);var b=f(a);if(1==b.length){var c=g(a.split("/"));e.steps=[c,[],[]]}else{var d=g(b[0].split("/")),h=g(b[1].split("/")),i=g(b[2].split("/"));e.steps=[d,h,i]}return BookKit._parsed_cfis[a]=e,e.steps}},i=function(a,b){var c=-1,d=null;if(a.index%2==0){var e=$(b).children();c=a.index/2-1,c<=e.length&&(d=$(e).eq(c)[0])}else c=a.index-1,b.childNodes[0].nodeType==Node.ELEMENT_NODE&&(c-=1),c<=b.childNodes.length&&(d=b.childNodes.item(c));return d},j=function(){if(e.ranges)return e.ranges;var a=e.steps,b=a[0],c=a[1],d=a[2];6!=b[0].index&&console.log("Malformed CFI. Spine should be sixth element of package",b[0]),b.splice(0,1);var f=document,g=f.documentElement;b.splice(0,1);var h=null,j=null,k=null,l=null,m=null;_.each(b,function(a){var b=i(a,g);g=b},this),h=g,e.node=h,c.length>0&&(g=h,_.each(c,function(a){var b=i(a,g);g=b}),null!=_.last(c).offset&&(k=_.last(c).offset),j=g),d.length>0&&(g=h,_.each(d,function(a){var b=i(a,g);g=b}),null!=_.last(d).offset&&(m=_.last(d).offset),l=g);var n=f.createRange();if(null!=j&&null!=k&&null!=l&&null!=m)n.setStart(j,k),n.setEnd(l,m),e.range=n,e.ranges=BookKit.CFI.getSafeRanges(n);else if(null!=l){var o=0;null!=_.last(b).offset&&(o=_.last(b).offset),o>=l.length-1&&(o-=1),o>=0&&(n.setStart(node,o),n.setEnd(node,o+1),e.range=n,e.ranges=[n])}return e.ranges};e.parseAndResolve=function(){return null==e.steps&&h(),(null==e.range||null==e.ranges)&&j(),e},e.safeAttr=function(){var a=e.cfistring;return a.replace(/[\:\/\,]/g,"_").replace(/[\!\(\)\[\]]/g,"")},e.rects=function(){var a=[];return $.each(e.ranges,function(b,c){$.each(c.getClientRects(),function(b,c){a.push(c)})}),a},e.containsPoint=function(a,b){rects=e.rects();var c=!1;return $.each(rects,function(d,e){a>=e.left&&a<=e.left+e.width&&b>=e.top&&b<=e.top+e.height&&(c=!0)}),c},e.select=function(){var a=window.getSelection();a.removeAllRanges(),a.addRange(e.range),console.log(a.rangeCount)},e.intersects=function(a){var b=e.range.compareBoundaryPoints(Range.END_TO_END,a.range),c=e.range.compareBoundaryPoints(Range.END_TO_START,a.range),d=e.range.compareBoundaryPoints(Range.START_TO_END,a.range),f=e.range.compareBoundaryPoints(Range.START_TO_START,a.range);return 0==f&&0==b||d>=0&&0>=c||0>=f&&d>=0?!0:!1},e.merge=function(a){if(!e.intersects(a))return null;e.range.compareBoundaryPoints(Range.END_TO_END,a.range),e.range.compareBoundaryPoints(Range.END_TO_START,a.range),e.range.compareBoundaryPoints(Range.START_TO_END,a.range),e.range.compareBoundaryPoints(Range.START_TO_START,a.range);return null},e.init=function(){},e.init()},BookKit.CFI.documentStep="",BookKit.CFI.selectionCFI=function(){var a=window.getSelection();if(a.rangeCount>0){var b=window.getSelection().getRangeAt(0);return BookKit.CFI.cfiForRange(b)}},BookKit.CFI.cfiForRange=function(a){var b=BookKit.CFI.contentCFIForRange(a),c="epubcfi("+BookKit.CFI.documentStep+b+")";return new BookKit.CFI(c).parseAndResolve()},BookKit.CFI.contentCFIForRange=function(a){var b=BookKit.CFI.cfiStepsForNode(a.startContainer),c=BookKit.CFI.cfiStepsForNode(a.endContainer),d=[];_.every(b,function(a,e){return b[e]==c[e]&&e<b.length-1&&e<c.length-1?(d.push(a),!0):!1});var e="/"+d.join("/"),f="/"+b.join("/")+":"+a.startOffset,g="/"+c.join("/")+":"+a.endOffset;f=f.replace(e,""),g=g.replace(e,"");var h=null;return h=f!=g?e+","+f+","+g:e+f},BookKit.CFI.cfiStepsForNode=function(a){for(var b=[];a;){var c=0;_.each(a.parentNode.childNodes,function(a){a.nodeType==Node.COMMENT_NODE&&c++});var d=0;a.parentNode.childNodes[0].nodeType==Node.ELEMENT_NODE&&(d=1);var e=_.indexOf(a.parentNode.childNodes,a)+1-2*c+d;if(a.parentNode.nodeType!=Node.ELEMENT_NODE)break;e>0&&b.push(e),a=a.parentNode}return b.reverse()},BookKit.CFI.getSafeRanges=function(a){var b=a.commonAncestorContainer,c=new Array(0),d=new Array(0);if(a.startContainer!=b)for(var e=a.startContainer;e!=b;e=e.parentNode)c.push(e);if(0<c.length)for(var e=0;e<c.length;e++){var f=document.createRange();e?(f.setStartAfter(c[e-1]),f.setEndAfter(c[e].lastChild)):(f.setStart(c[e],a.startOffset),f.setEndAfter(c[e].nodeType==Node.TEXT_NODE?c[e]:c[e].lastChild)),d.push(f)}var g=new Array(0),h=new Array(0);if(a.endContainer!=b)for(var e=a.endContainer;e!=b;e=e.parentNode)g.push(e);if(0<g.length)for(var e=0;e<g.length;e++){var i=document.createRange();e?(i.setStartBefore(g[e].firstChild),i.setEndBefore(g[e-1])):(i.setStartBefore(g[e].nodeType==Node.TEXT_NODE?g[e]:g[e].firstChild),i.setEnd(g[e],a.endOffset)),h.unshift(i)}if(!(0<c.length&&0<g.length))return[a];var j=c[c.length-1],k=g[g.length-1],l=_.indexOf(b.childNodes,j),m=_.indexOf(b.childNodes,k),n=_.toArray(b.childNodes).splice(l+1,m-l-1);n=_.filter(n,function(a){return a.nodeType!=Node.TEXT_NODE||a.nodeValue.trim()});var o=[];_.each(n,function(a){var b=document.createRange();b.selectNodeContents(a),o.push(b)}),d.push(o),d=_.flatten(d);var p=d.concat(h);return p}}(),BookKit.Introspection={},BookKit.Introspection.numberOfPages=function(){return BookKit.Presentation.totalColumns()},BookKit.Introspection.currentPage=function(){return BookKit.Presentation.currentColumnNumber()};var BookKit=BookKit||{};BookKit.Layer=BookKit.Layer||{},function(){BookKit.Layer.AnnotationCanvas=function(a){var b=this,c={underlineThickness:2,padding:50,colors:{highlight:{none:"transparent",yellow:"#ffff6d",pink:"#ff80d5",red:"#ff9380",purple:"#b063ff",blue:"#80caff",green:"#b4ff6d",black:"transparent"},underline:{none:"transparent",yellow:"transparent",pink:"transparent",red:"#fb0011",purple:"#8000ff",blue:"#0080ff",green:"#44b705",black:"#000000"},note:{none:"transparent",yellow:"transparent",pink:"transparent",red:"#fb0011",purple:"#8000ff",blue:"#0080ff",green:"#44b705",black:"#000000"}}};b.options=$.extend({},c,a),b.presentation=void 0,b.canvas=void 0,b.width=null,b.height=null,b.canvasContext=function(){var a=document.getCSSCanvasContext("2d","-BookKit-Annotation-Canvas",b.width,b.height);return a},b.renderHighlight=function(a){var c=a.cfi,d=a.options.highlightStyle,e=a.options.highlightColor,f=b.canvasContext();_.each(c.ranges,function(a){_.each(a.getClientRects(),function(a){if("highlight"==d&&(f.fillStyle=b.options.colors.highlight[e]),"underline"==d){var g=a.top+a.height-b.options.underlineThickness;f.fillStyle=b.options.colors.underline[e],a.top=g,a.height=b.options.underlineThickness}var h=b.$el.scrollLeft(),i=b.$el.scrollTop();f.fillRect(a.left+h,a.top+i,a.width,a.height),BookKit.Annotations[c.cfistring].rects.push(a)})})},b.renderBookmark=function(a){{var c=a.cfi,d=a.options.bookmarkStyle;a.options.bookmarkColor}if("icon"==d){var e=b.canvasContext(),f=b.presentation.actualContentWidth(),g=c.ranges[0].getClientRects()[0],h=b.presentation.currentContentPosition(g.left),i=f*h+b.options.padding,j={left:i,top:g.top,right:i+g.height,width:g.height,height:g.height};e.fillStyle="#000000",e.textAlign="left",e.textBaseline="top",BookKit.Annotations[c.cfistring].rects.push(j)}},b.renderNote=function(a){var c=a.cfi,d=(a.options.noteText,a.options.noteStyle),e=a.options.noteColor;if("icon"==d){var f=b.canvasContext(),g=b.presentation.actualContentWidth(),h=c.ranges[0].getClientRects()[0],i=b.presentation.currentContentPosition(h.left),j=g*i+b.options.padding,k={left:j,top:h.top,right:j+h.height,width:h.height,height:h.height};f.fillStyle=b.options.colors.note[e],f.textAlign="left",f.textBaseline="top",BookKit.Annotations[c.cfistring].rects.push(k)}},b.redraw=function(){$.each(BookKit.Annotations,function(a,c){b.remove(c),b.render(c)})},b.render=function(a){BookKit.Annotations[a.cfi.cfistring].rects=[],a.options.bookmark&&b.renderBookmark(a),a.options.highlight&&b.renderHighlight(a),a.options.note&&b.renderNote(a)},remove=function(a){var c=BookKit.Annotations[a.cfi.cfistring].rects,d=b.canvasContext();_.each(c,function(a){d.clearRect(a.left,a.top,a.width,a.height)}),BookKit.Annotations[a.cfi.cfistring].rects=[]},b.init=function(){$(document).on("presented",function(a,c){b.presentation=c,b.$el=$(b.presentation.options.presentationElement),b.width=b.presentation.width(),b.height=b.presentation.height(),b.$el=$(b.presentation.options.presentationElement);var d=document.createElement("canvas");$(d).attr("id","-BookKit-Annotation-Canvas"),$(d).attr("width",b.width),$(d).attr("height",b.height),$(d).css("position","fixed"),b.$el.css("background","-webkit-canvas(-BookKit-Annotation-Canvas) no-repeat"),b.canvas=d,_.each(BookKit.Annotations,function(a){b.render(a)})}),$(document).on("addedAnnotation",function(a,c){b.render(c)}),$(document).on("removedAnnotation",function(a,c){b.remove(c)}),$(document).on("presentationChanged",function(){b.redraw()})},b.init()},BookKit.Layer.HTMLAnnotations=function(a){var b=this,c={};b.options=$.extend({},c,a),b.init=function(){$(document).on("presented",function(a,c){b.presentation=c,b.$el=$(b.presentation.options.presentationElement)}),$(document).on("addedAnnotation",function(){}),$(document).on("removedAnnotation",function(){})},b.init()}}();var BookKit=BookKit||{};!function(){BookKit.Presentation=function(a){var b=this,c={horizontalPadding:100,verticalPadding:100,presentationElement:"body",viewportElement:window,animationDuration:0,behaviors:{},layers:{}};b.options=$.extend(!0,{},c,a),b.presentationContainer=void 0,b.viewportHeight=function(){return $(b.options.viewportElement).height()},b.height=function(){return $(b.options.presentationElement)[0].scrollHeight},b.innerHeight=function(){return parseInt(b.height()-2*b.options.verticalPadding)},b.viewportWidth=function(){return b.options.viewportElement.innerWidth},b.width=function(){return $(b.options.presentationElement)[0].scrollWidth},b.innerWidth=function(){return b.width()-2*b.options.horizontalPadding},b.contentHeight=function(){return b.height()},b.innerContentHeight=function(){return b.innerHeight()},b.contentWidth=function(){return b.width()},b.innerContentWidth=function(){return b.innerWidth()},b.actualContentWidth=function(){return b.width()},b.contentDivisions=function(){return 1},b.contentPositionForOffset=function(){return 0},b.currentContentPosition=function(){return 0},b.rangeForCurrentContentPosition=function(){var a=b.currentColumnNumber(),c=document.caretRangeFromPoint(a,0);return c},b.init=function(){$(document).on("ready",function(){b.presentationContainer=document.createElement("div"),$(b.presentationContainer).attr("id","-BookKit-Presentation"),$(b.presentationContainer).appendTo(b.options.presentationElement);var a=$(b.options.presentationElement);a.css("margin",0),a.css("padding-top",b.options.verticalPadding),a.css("padding-bottom",b.options.verticalPadding),a.css("padding-left",b.options.horizontalPadding),a.css("padding-right",b.options.horizontalPadding),a.css("height",b.innerHeight()),a.css("width",b.innerWidth()),$(document).trigger("presented",[b])}.bind(b)),$(window).resize()},b.init()},BookKit.ColumnedPresentation=function(a){var b=this,c=new BookKit.Presentation(a);b=$.extend(!0,c,b);var d={columns:1,columnsToScroll:1,columnToStart:0,behaviors:{}};b.options=$.extend(!0,c.options,d,a),b.height=function(){return b.viewportHeight()},b.innerHeight=function(){return parseInt(b.height()-2*b.options.verticalPadding)},b.viewportWidth=function(){var a=b.options.viewportElement.innerWidth;return a},b.width=function(){return $(b.options.presentationElement)[0].scrollWidth},b.innerWidth=function(){return b.width()-2*b.options.horizontalPadding},b.contentHeight=function(){return b.height()},b.innerContentHeight=function(){return b.innerHeight()},b.contentWidth=function(){return parseInt(b.viewportWidth()/b.options.columns)},b.innerContentWidth=function(){return parseInt(b.contentWidth()-2*b.options.horizontalPadding)},b.actualContentWidth=function(){var a=Math.floor((b.width()-b.options.horizontalPadding)/b.contentWidth());(isNaN(a)||1>a)&&(a=1);var c=$(b.options.presentationElement)[0].scrollWidth/a;return Math.ceil(c)},b.contentDivisions=function(){var a=Math.floor((b.width()-b.options.horizontalPadding)/b.actualContentWidth());return(isNaN(a)||1>a)&&(a=1),a},b.contentPositionForOffset=function(a){var c=b.contentWidth(),d=parseInt(a/c);return d},b.currentContentPosition=function(){var a=$(b.options.presentationElement).scrollLeft(),c=b.contentPositionForOffset(a);return Math.ceil(c)},setColumnSizes=function(){var a=$(b.options.presentationElement),c=b.innerHeight(),d=2*b.options.horizontalPadding,e=b.innerContentWidth();a.css("overflow","hidden"),a.css("margin",0),a.css("padding-top",b.options.verticalPadding),a.css("padding-bottom",b.options.verticalPadding),a.css("padding-left",b.options.horizontalPadding),a.css("padding-right",b.options.horizontalPadding),a.css("height",c+"px"),a.css("-webkit-column-width",e+"px"),a.css("-webkit-column-gap",d+"px"),a.css("-webkit-column-rule","1px outset #eeeeee"),a.css("width",b.innerWidth()),$(document).trigger("presented",[b])},b.init=function(){$(document).on("ready",function(){b.presentationContainer=document.createElement("div"),$(b.presentationContainer).attr("id","-BookKit-Presentation"),$(b.presentationContainer).appendTo(b.options.presentationElement),$(document).ready(setColumnSizes)}.bind(b)),$(window).resize(setColumnSizes)},b.init()}}(),!function(a){function b(a){a.fn.measure=function(b){var c,d=a(this).clone();return d.css({visibility:"hidden",position:"absolute"}),d.appendTo(document.body),"function"==typeof b&&(c=b.apply(d)),d.remove(),c}}"function"==typeof define&&define.amd?define(["jquery"],b):b(a.jQuery)}(this);